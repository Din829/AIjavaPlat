# 社内業務サポートAIプラットフォーム - 前端开发计划 (正式版)

## MVP 完成状况总结

前端 MVP 开发阶段已实现以下核心功能：
- 项目初始化 (Vite, Vue3, TypeScript) 及核心库集成 (Pinia, Vue Router, Naive UI, Axios)。
- 完整的用户认证流程 (登录、注册、登出、路由守卫、状态持久化)。
- API Token 管理功能 (列表、创建、删除)。
- Prompt 管理功能 (列表、创建、编辑、删除)。
- 网页内容摘要功能，支持用户选择 API Token。
- OCR文档处理功能，包括文件上传、处理选项配置、状态显示和结果展示。
- API 服务层、状态管理模块化以及基础的全局错误处理。

主要的 MVP 收尾工作包括：解决已知的 TypeScript 类型检查问题 (已通过创建单独的类型定义文件解决部分问题) 和 Naive UI 全局消息提示的渲染 bug，以及完成代码审查、构建测试。

## 当前未解决的问题

在OCR前端功能实现过程中，我们遇到了以下尚未解决的问题：

1. **API请求超时错误**：
   ```
   apiClient.ts:39 API request error: {message: 'timeout of 90000ms exceeded', url: '/api/ocr/upload', method: 'post', status: undefined, data: undefined, …}
   ```

   尽管我们已经将Axios的超时设置为90秒，但在上传大文件时仍然会出现超时错误。这可能是由于文件大小、网络状况或后端处理时间过长导致的。

2. **上传文件后的加载视觉效果不显示**：
   虽然我们修复了页面加载时错误显示加载指示器的问题，但上传文件后的加载视觉效果仍然不显示。这可能是由于状态管理或条件判断逻辑的问题。

3. **类型导入错误**（已解决）：
   ```
   SyntaxError: The requested module '/src/services/ocrService.ts?t=1747740415669' does not provide an export named 'OcrTaskResponse' (at ocrStore.ts:2:22)
   ```

   我们通过创建单独的类型定义文件`types/ocr.ts`并修改导入路径解决了这个问题。

4. **下一步解决方案**：
   - **API超时问题**：
     - 考虑实现分块上传功能，将大文件分成小块上传
     - 调整后端处理逻辑，提高处理速度
     - 实现更可靠的错误恢复机制
   - **加载视觉效果问题**：
     - 进一步检查状态管理逻辑，确保状态正确更新
     - 添加更多的调试日志，定位问题根源
     - 考虑使用更简单的加载指示器实现方式

---

## 正式版开发规划

### 已完成模块：OCR文档处理与交互界面

**总体方向：**
为用户提供流畅的文档上传体验，清晰地展示后端OCR服务处理后的文档内容，并逐步构建支持更高级文档交互（如内容选择、高亮、未来可能的文档问答）的用户界面。

**已实现的功能：**

1.  **核心页面与组件：**
    *   **已实现 `OcrPage.vue`：** 作为OCR功能主界面，提供完整的文档上传、处理和结果展示功能。
    *   **文件上传组件：** 使用Naive UI的`n-upload`和`n-upload-dragger`组件，支持拖放和文件选择，并提供文件格式限制。
    *   **处理选项配置：** 提供OCR处理选项的配置界面，包括：
        *   使用PyPDF2提取文本
        *   使用Docling进行OCR
        *   使用Gemini进行内容分析
        *   强制OCR处理（即使PDF包含文本）
        *   语言选择（自动检测、中文、英文、日文、韩文、中英混合）
    *   **处理状态与反馈：** 使用Naive UI的`n-spin`和`messageService`，清晰展示上传进度、后端处理状态（等待、处理中、成功、失败）及错误信息。
    *   **结果展示组件：** 使用Naive UI的`n-tabs`、`n-tab-pane`、`n-scrollbar`和`n-data-table`组件，以多标签页的形式展示OCR处理结果，包括：
        *   文本内容标签页：显示提取的文本内容
        *   表格内容标签页：使用`n-data-table`展示提取的表格数据
        *   内容分析标签页：显示Gemini生成的内容分析结果
        *   原始JSON标签页：显示后端返回的完整JSON数据

2.  **API服务层 (`src/services/ocrService.ts`)：**
    *   已实现OCR服务API的封装，包括：
        *   `uploadFile`：上传文件并处理
        *   `getTaskStatus`：获取任务状态
        *   `getTaskResult`：获取任务结果
        *   `getUserTasks`：获取用户的所有OCR任务
    *   定义了OCR相关的类型，包括：
        *   `OcrTaskStatus`：OCR任务状态枚举
        *   `OcrUploadRequest`：OCR上传请求参数接口
        *   `OcrTaskResponse`：OCR任务响应接口

3.  **状态管理 (`src/stores/ocrStore.ts` - Pinia)：**
    *   已实现OCR状态管理，包括：
        *   管理文件上传状态
        *   管理OCR任务状态
        *   处理异步轮询
        *   管理后端返回的结果数据
    *   实现了以下Actions：
        *   `uploadFile`：上传文件并处理
        *   `getTaskStatus`：获取任务状态
        *   `getTaskResult`：获取任务结果
        *   `getUserTasks`：获取用户的所有OCR任务
        *   `startPolling`：开始轮询任务状态
        *   `stopPolling`：停止轮询任务状态
        *   `reset`：重置状态

4.  **类型定义 (`src/types/ocr.ts`)：**
    *   为了解决循环依赖和导入问题，创建了单独的类型定义文件，包括：
        *   `OcrTaskStatus`：OCR任务状态枚举
        *   `OcrUploadRequest`：OCR上传请求参数接口
        *   `OcrTaskResponse`：OCR任务响应接口

5.  **数据处理与渲染逻辑：**
    *   实现了对后端返回的JSON数据的解析和渲染，包括：
        *   文本内容的展示
        *   表格数据的展示
        *   内容分析结果的展示
    *   实现了简单的格式化处理，将Markdown格式的内容转换为HTML进行展示

**今日进度更新（2024-05-31）：**

1. **OCR用户体验重大优化：**
   * ✅ **修复加载提示显示问题**：解决了上传文件后加载提示只在最后1秒显示的问题
     - 优化了ocrStore中的startPolling逻辑，只要有任务ID就设置isProcessing为true
     - 修改了前端显示条件，实现智能显示逻辑，覆盖上传、处理、等待等各种状态
   * ✅ **实现智能进度模拟**：根据时间和模型类型显示处理进度
     - 添加了4个处理步骤：文档上传 → 文字识别处理 → AI内容分析 → 结果整理
     - 根据Gemini模型类型（Flash/Pro）调整预计时间和进度阶段
     - 实现了动态进度计算，基于任务创建时间模拟真实处理进度
   * ✅ **现代化UI设计**：参考主流应用设计模式优化进度显示界面
     - 采用现代化的卡片式布局，渐变背景和阴影效果
     - 实现了清晰的状态区分：已完成(绿色)、进行中(蓝色+动画)、等待中(灰色)
     - 添加了进度摘要显示，如"1/4 步骤完成 (25%)"

2. **技术实现细节：**
   * 修改了`my-ai-platform-frontend/src/stores/ocrStore.ts`的状态管理逻辑
   * 重构了`my-ai-platform-frontend/src/views/OcrPage.vue`的进度显示组件
   * 添加了智能进度步骤计算和进度摘要功能
   * 优化了CSS样式，实现现代化的视觉效果

3. **用户体验提升效果：**
   * 用户上传文件后立即看到处理进度，不再困惑
   * 清楚了解当前处理到哪个阶段，预计还需要多长时间
   * 视觉效果更加专业和现代化，提升了整体产品质感

**下一步计划：**

1.  **进度显示进一步优化（可选）：**
    *   实现真实后端进度同步（如果需要更精确的进度反馈）
    *   添加处理时间预估的动态调整机制
    *   考虑添加取消处理功能

2.  **性能优化：**
    *   解决API请求超时问题，考虑实现分块上传
    *   优化大型文档的渲染性能
    *   实现更高效的表格数据处理

3.  **用户体验增强：**
    *   实现文本选择与复制功能
    *   提供下载和分享功能，方便用户保存和分享OCR结果
    *   实现多文档管理界面，支持历史记录查询
    *   添加文件预览功能

4.  **功能增强：**
    *   支持更多文档格式的预览
    *   实现更高级的文档交互功能
    *   添加批量文档处理功能

5.  **(远期) 文档问答界面集成：**
    *   配合后端文档问答功能的实现，设计和开发相应的用户问答交互界面

**已解决的历史问题：**
- ✅ 上传文件后的加载视觉效果不显示问题（已通过智能进度显示解决）
- ✅ 页面加载时错误显示加载指示器问题（已解决）
- ✅ 类型导入错误问题（已通过创建单独类型文件解决）

**当前仍需关注的问题：**
- ⚠️ API请求超时错误：上传大文件时出现90000ms超时（需要后端配合优化）

## 📅 最新进展（2025-01-27）

### ✅ Excel文件支持新增
1. **文件类型扩展**：新增Excel文件格式支持（.xlsx, .xls, .xlsm）
   - 更新前端文件上传组件的`acceptFileTypes`配置
   - 修改上传提示文本，包含Excel文件格式说明
   - 与后端Java和Python微服务完整集成

2. **技术实现细节**：
   - 前端文件类型检测：支持Excel格式识别
   - 上传界面优化：更新提示文本为"支持PDF、图片、Excel等文件格式"
   - 保持现有OCR处理流程不变，Excel文件通过后端Apache POI处理

3. **用户体验提升**：
   - 用户可以直接上传Excel文件进行文本提取
   - 支持多工作表Excel文件处理
   - 表格数据结构化展示，保持原始格式

### 🔧 文件修改记录
- `my-ai-platform-frontend/src/views/OcrPage.vue`：
  - 更新`acceptFileTypes`：添加`.xlsx,.xls,.xlsm`
  - 修改上传提示文本

### ✅ Word文档和文本文件支持新增（2025-01-27）
1. **Word文档支持**：新增Word文档格式支持（.docx, .doc）✨
   - 前端文件类型扩展：添加Word格式到`acceptFileTypes`
   - 后端完整集成：Java Apache POI + Python python-docx
   - 支持段落、表格、格式化文本提取

2. **文本文件支持**：新增多种文本格式支持✨
   - **纯文本**：.txt, .md, .rtf格式
   - **表格数据**：.csv, .tsv格式
   - **多编码支持**：自动检测UTF-8, GBK, GB2312等编码
   - **智能解析**：CSV/TSV表格结构化处理

3. **用户界面优化**：
   - 更新上传提示：支持PDF、图片、Excel、Word、文本、CSV等文件格式
   - 文件类型检测：前端支持7种主要文档格式
   - 统一处理流程：所有文件类型使用相同的OCR界面

### ✅ 富文本显示功能实现（2025-01-27）
1. **图像内嵌文本显示**：实现文本内容中图像的正确位置显示✨
   - **RichTextDisplay组件**：创建专用富文本显示组件
   - **图像标记解析**：解析`[IMAGE:id:description]`标记并渲染为实际图像
   - **混合内容显示**：文本与图像在同一区域内按位置正确显示
   - **响应式设计**：图像自适应大小，支持移动端显示

2. **技术实现细节**：
   - **Python服务修改**：在文本中插入图像位置标记
   - **前端组件开发**：`RichTextDisplay.vue`组件处理富文本渲染
   - **图像处理**：Base64图像数据内联显示，支持错误处理
   - **样式优化**：图像边框、阴影、标题等视觉效果

3. **用户体验提升**：
   - **直观显示**：图像在文本中的正确位置显示，不再分离
   - **视觉效果**：图像带有边框、阴影和描述文字
   - **性能优化**：图像加载错误处理，避免显示问题

### 🔧 今日文件修改记录（2025-01-27）
- `ocr_service.py`：
  - 修改图像提取逻辑，在文本中插入图像标记
  - 重新构建包含图像标记的全文内容
- `my-ai-platform-frontend/src/components/RichTextDisplay.vue`：
  - 新建富文本显示组件
  - 实现图像标记解析和渲染逻辑
- `my-ai-platform-frontend/src/views/OcrPage.vue`：
  - 集成RichTextDisplay组件
  - 替换原有的纯文本显示

### 📋 下一步计划
1. **图像显示优化**：调整图像比例和布局，避免拉伸变形
2. **PowerPoint支持**：考虑添加PPT文件格式支持（.pptx, .ppt）
3. **批量文档处理**：支持多文件同时上传和处理
4. **文档预览功能**：为不同文档类型提供预览界面
5. **文件格式图标**：为不同文件类型显示对应图标