# 后端OCR功能开发进度与计划 (截至 2024-05-18)

## 今日主要进展与讨论成果

1.  **明确OCR功能实现的技术选型（方案A）：**
    *   **核心思路：** 由一个独立的Python微服务主导文档处理，Java后端负责业务逻辑和API暴露。
    *   **Python微服务职责：**
        *   **Docling主导深度文档解析：** 利用Docling内置的解析器、布局分析模型（如DocLayNet）、表格识别模型（如TableFormer）及可配置的OCR引擎（如Tesseract, EasyOCR）进行全面的结构化解析。
        *   **（可选）Gemini进行靶向增强：** 对于Docling难以处理的特定图像区域或内容块，调用Gemini API进行增强处理。
        *   **核心输出：** 一份详尽的、结构化的JSON文档，作为与Java后端交互的数据契约。
    *   **Java后端职责：**
        *   新增`OcrController`和`OcrService`。
        *   负责接收前端文件上传，调用Python OCR微服务，管理可能的异步任务，处理并向前端返回结果。
    *   **前端职责：**
        *   实现文件上传界面。
        *   核心挑战在于解析并渲染后端返回的结构化JSON，以尽可能还原文档原貌。

2.  **Python微服务实现遭遇核心库导入难题并确立解决方案：**
    *   在尝试实现Python微服务 (`ocr_service.py`) 时，遇到了 `docling` 库核心数据模型（特别是代表页面和元素的类）无法按预期方式导入的严重且持续的问题。详细的排查过程已记录在 `0518问题.txt`。
    *   **最终解决方案**：鉴于直接导入细粒度类型定义不可行，Python微服务将采用"黑盒"处理方式：
        *   仅导入可确认的 `docling.document_converter.DocumentConverter` 和 `docling_core.types.DoclingDocument` (作为内部文档对象的核心类型)。
        *   通过运行时属性探查（如 `type()`, `dir()`, `getattr()`, `hasattr()`）和防御性编程，来遍历和解析 `DoclingDocument` 对象内部的页面和元素结构。
        *   目标仍然是生成符合先前定义的结构化JSON草案的输出，但数据提取的完善程度将依赖于运行时的调试和迭代。

3.  **定义了Python微服务输出的JSON核心结构草案：**
    *   该JSON结构旨在全面描述文档内容和结构，包含`document_metadata`、`pages`（内含`elements`数组，每个元素有`id`, `type`, `bbox`, `content_text`, `style_info`以及类型特有属性如`level` for heading, `items` for list, `rows`/`cells` for table, `src_type`/`data` for image, `content_items` for generic `block`等）。
    *   此结构为前后端开发提供了关键的数据交换标准。

4.  **更新了核心项目规划文档：**
    *   `DEVELOPMENT_PLAN.md`：更新了"智能OCR及文档理解服务"模块的规划，明确了技术实现路径（方案A），细化了Python微服务职责、Java后端集成方式、API设计要点，并包含了JSON输出结构草案。
    *   `my-ai-platform-frontend/FRONTEND_PLAN.md`：更新了"OCR文档处理与交互界面"模块的规划，明确了前端将接收和处理后端返回的结构化JSON，并强调了渲染此JSON的挑战和策略，以及对后端计划中定义的JSON结构的依赖。

## 当前状态

*   OCR功能的整体技术方案（Python微服务 + Java后端）和前后端职责已明确。
*   Python微服务 (`ocr_service.py`) 已初步搭建并**能够成功启动**，可以接收文件上传并调用 `docling` 的 `DocumentConverter`。
*   核心的 `DoclingDocument` 到自定义JSON的转换逻辑目前是基于"黑盒"处理和防御性编程实现的。其输出JSON的详细程度和准确性**高度依赖后续的运行时调试和对 `DoclingDocument` 实际内部结构的分析**。
*   核心数据交换格式（Python微服务输出的JSON结构草案）仍然有效，作为数据提取的目标格式。
*   问题排查的详细过程和当前策略已记录在 `0518问题.txt`。

## 下一步行动计划

1.  **【核心任务 - Python微服务】通过运行时调试，完善从 `DoclingDocument` 到预定义JSON的转换逻辑：**
    *   **任务1.1：处理多种代表性文档**：使用 `ocr_service.py` 处理包括简单文本、复杂布局、包含表格、列表、图片的PDF以及扫描件等。
    *   **任务1.2：分析运行时日志**：重点关注 `ocr_service.py` 中转换函数打印出的 `DoclingDocument` 内部页面对象和元素对象的实际类型 (`type()`) 和可用属性 (`dir()`)。
    *   **任务1.3：迭代优化数据提取代码**：根据日志分析结果，在 `docling_element_to_custom_json` 和 `convert_docling_to_custom_json` 函数中，精确地使用 `getattr()` 等方法提取所需属性（如id, type, bbox, texts, style, props中的具体内容），以填充我们预定义的JSON结构。
    *   **任务1.4：逐步完善对表格、列表、图片等复杂元素的数据提取和结构化表示。**

2.  **【后端Python微服务】Gemini靶向增强原型（优先级稍后）：**
    *   在核心的Docling结构化输出基本稳定后，再针对Docling处理不佳的特定图片或文本块，编写脚本调用Gemini API进行处理，并探索如何将结果有效整合回主JSON结构中。

3.  **【后端Java】API设计与初步实现（可与Python微服务并行，依赖JSON结构）：**
    *   任务3.1：设计`OcrController`的API端点 (文件上传、状态查询、结果获取)。
    *   任务3.2：设计`OcrService`接口，明确与Python微服务的交互方式（初步可考虑同步调用，后续评估异步）。
    *   任务3.3：创建相关的DTOs，特别是用于承载从Python微服务获取的（将逐步完善的）JSON结果的DTO。

4.  **【前端】技术预研与初步设计（可与Python微服务并行，依赖JSON结构）：**
    *   任务4.1：研究前端渲染方案：针对后端定义的JSON结构，继续调研如何高效、灵活地在Vue中将其渲染出来，特别是基于`bbox`的布局和复杂元素的展示。
    *   任务4.2：设计`OcrPage.vue`的初步界面布局和用户交互流程。
    *   任务4.3：规划`ocrStore.ts`的状态和actions，以配合后端的API和数据结构。

5.  **【团队协同】明确初期交付范围（MVP of OCR v0.1）：**
    *   基于当前"黑盒"处理策略，重新评估OCR功能第一个可交付版本（例如v0.1）能达到的目标：
        *   支持的文档类型（例如，先确保打印版PDF的文本和基本布局）。
        *   输出JSON中包含信息的详细程度（例如，可能初期表格和列表的结构化程度较低）。
        *   前端渲染的保真度级别。

---
*本文档将根据后续开发进展持续更新。* 